{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "SOC Entity Triage",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "sentinel",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "/subscriptions/193adb00-3bae-469e-b548-830a894810a0/resourcegroups/quzara-monitoring/providers/microsoft.operationalinsights/workspaces/quzara-corporate",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2022-04-01",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"5bd9a922-e882-44c1-8949-26cc24946e6a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"EntityType\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    { \\\"value\\\":\\\"ip\\\", \\\"label\\\":\\\"Private IP Address\\\" },\\r\\n    { \\\"value\\\":\\\"publicip\\\", \\\"label\\\":\\\"Public IP Address\\\" },\\r\\n    { \\\"value\\\":\\\"host\\\", \\\"label\\\":\\\"Hostname\\\" },\\r\\n    { \\\"value\\\":\\\"aduser\\\", \\\"label\\\":\\\"AD User\\\" },\\r\\n    { \\\"value\\\":\\\"user\\\", \\\"label\\\":\\\"Email Account\\\", \\\"selected\\\":true }\\r\\n]\",\"timeContext\":{\"durationMs\":86400000},\"value\":\"ip\"},{\"id\":\"c7443067-b1f9-4f4d-aa89-c4cd27ed5c0f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Variable\",\"type\":1,\"isRequired\":true,\"timeContext\":{\"durationMs\":86400000},\"value\":\"\"},{\"id\":\"90a2a2a2-729f-4016-9f4e-4f3df925429f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Timerange\",\"label\":\"\",\"type\":4,\"description\":\"1d, 30m, etc\",\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":86400000}},{\"id\":\"73a0398e-cf7c-497a-83cb-76dff4c413de\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspace\",\"label\":\"Client\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources | where type =~ 'Microsoft.operationsmanagement/solutions' | where name contains 'SecurityInsights' | project id = tostring(properties.workspaceResourceId)\\r\\n\",\"crossComponentResources\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":[\"value::all\"]}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityAlert\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| search @'{Variable}'\\r\\n| project AlertTime = TimeGenerated, \\r\\n          AlertName = DisplayName, \\r\\n          AlertDescription = Description\\r\\n| order by AlertTime desc\",\"size\":1,\"showAnalytics\":true,\"title\":\"SecurityAlert Involving Entity\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"rowLimit\":50}},\"name\":\"SecurityAlert Involving Entity\",\"styleSettings\":{\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Email Triage\",\"loadType\":\"explicit\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"IdentityInfo\\r\\n| where TimeGenerated >= ago (30d)\\r\\n| where AccountUPN =~ \\\"{Variable}\\\"\\r\\n| take 1\\r\\n| extend Location = strcat(\\r\\n    iff(isempty(StreetAddress), '', strcat(StreetAddress, ', ')), \\r\\n    iff(isempty(City), '', strcat(City, ', ')), \\r\\n    iff(isempty(State), '', strcat(State)) \\r\\n)\\r\\n| project AccountDisplayName, AccountCreationTime, Department, JobTitle, Location, Phone, Enabled = IsAccountEnabled\\r\\n\",\"size\":3,\"showAnalytics\":true,\"title\":\"Identity Info via UPN\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"Identity Info via UPN\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| where UserPrincipalName =~ '{Variable}'\\r\\n| extend authenticationMethod_ = tostring(parse_json(AuthenticationDetails)[0].authenticationMethod)\\r\\n| extend authenticationStepResultDetail_ = tostring(parse_json(AuthenticationDetails)[0].authenticationStepResultDetail)\\r\\n| extend succeeded_ = tostring(parse_json(AuthenticationDetails)[0].succeeded)\\r\\n| extend DeviceName = tostring(DeviceDetail.displayName)\\r\\n| extend DeviceTrustType = tostring(DeviceDetail.trustType)\\r\\n| extend operatingSystem_ = tostring(DeviceDetail.operatingSystem)\\r\\n| extend city_ = tostring(LocationDetails.city)\\r\\n| extend state_ = tostring(LocationDetails.state)\\r\\n| extend countryOrRegion_ = tostring(LocationDetails.countryOrRegion)\\r\\n| extend fullLocation = strcat(\\r\\n    iff(isempty(city_), '', strcat(city_, ', ')), \\r\\n    iff(isempty(state_), '', strcat(state_, ', ')), \\r\\n    countryOrRegion_\\r\\n)\\r\\n| where succeeded_ == \\\"true\\\"\\r\\n| summarize count() by fullLocation, IPAddress\\r\\n\",\"size\":3,\"showAnalytics\":true,\"title\":\"Summarize signin locations for user\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"customWidth\":\"45\",\"name\":\"Summarize signin locations for user\",\"styleSettings\":{\"maxWidth\":\"45\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| where UserPrincipalName =~ '{Variable}'\\r\\n| extend DeviceName = tostring(DeviceDetail.displayName)\\r\\n| extend DeviceOS = tostring(DeviceDetail.operatingSystem)\\r\\n| summarize HostsSignedInto = dcount(DeviceName) by DeviceName, DeviceOS, UserPrincipalName\\r\\n| project UserPrincipalName, DeviceName, DeviceOS, HostsSignedInto\\r\\n| sort by HostsSignedInto desc\\r\\n| project-away HostsSignedInto\",\"size\":3,\"showAnalytics\":true,\"title\":\"Hosts a user has signed into\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"DeviceOS\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"DeviceOS\",\"sortOrder\":1}]},\"customWidth\":\"45\",\"name\":\"Hosts a user has signed into\",\"styleSettings\":{\"maxWidth\":\"45\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| where UserPrincipalName =~ '{Variable}'\\r\\n| extend authenticationMethod_ = tostring(parse_json(AuthenticationDetails)[0].authenticationMethod)\\r\\n| extend authenticationStepResultDetail_ = tostring(parse_json(AuthenticationDetails)[0].authenticationStepResultDetail)\\r\\n| extend succeeded_ = tostring(parse_json(AuthenticationDetails)[0].succeeded)\\r\\n| where (ResultType in (\\\"0\\\", \\\"Success\\\")) or (succeeded_ == \\\"true\\\")\\r\\n| extend DeviceName = tostring(DeviceDetail.displayName)\\r\\n| extend DeviceTrustType = tostring(DeviceDetail.trustType)\\r\\n| extend operatingSystem_ = tostring(DeviceDetail.operatingSystem)\\r\\n| extend city_ = tostring(LocationDetails.city)\\r\\n| extend state_ = tostring(LocationDetails.state)\\r\\n| extend countryOrRegion_ = tostring(LocationDetails.countryOrRegion)\\r\\n| extend fullLocation = strcat(\\r\\n    iff(isempty(city_), '', strcat(city_, ', ')), \\r\\n    iff(isempty(state_), '', strcat(state_, ', ')), \\r\\n    countryOrRegion_\\r\\n)\\r\\n| project TimeGenerated, IPAddress, ResultDescription, SourceSystem, AppDisplayName, authenticationMethod_, authenticationStepResultDetail_, succeeded_, ConditionalAccessStatus, DeviceName, DeviceTrustType, operatingSystem_, fullLocation, UserAgent, UserType\\r\\n| order by TimeGenerated desc\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Successful SignInLogs Activity\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"Successful SignInLogs Activity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| where UserPrincipalName =~'{Variable}'\\r\\n| extend authenticationMethod_ = tostring(parse_json(AuthenticationDetails)[0].authenticationMethod)\\r\\n| extend authenticationStepResultDetail_ = tostring(parse_json(AuthenticationDetails)[0].authenticationStepResultDetail)\\r\\n| extend succeeded_ = tostring(parse_json(AuthenticationDetails)[0].succeeded)\\r\\n| extend DeviceName = tostring(DeviceDetail.displayName)\\r\\n| extend DeviceTrustType = tostring(DeviceDetail.trustType)\\r\\n| extend operatingSystem_ = tostring(DeviceDetail.operatingSystem)\\r\\n| extend city_ = tostring(LocationDetails.city)\\r\\n| extend state_ = tostring(LocationDetails.state)\\r\\n| extend countryOrRegion_ = tostring(LocationDetails.countryOrRegion)\\r\\n| extend fullLocation = strcat(\\r\\n    iff(isempty(city_), '', strcat(city_, ', ')), \\r\\n    iff(isempty(state_), '', strcat(state_, ', ')), \\r\\n    countryOrRegion_\\r\\n)\\r\\n| where succeeded_ == \\\"false\\\"\\r\\n| project TimeGenerated, IPAddress, ResultDescription, SourceSystem, AppDisplayName, authenticationMethod_, authenticationStepResultDetail_, succeeded_, ConditionalAccessStatus, DeviceName, DeviceTrustType, operatingSystem_, fullLocation, UserAgent, UserType\\r\\n| order by TimeGenerated desc\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Failed SignInLogs Activity\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"filter\":true}},\"name\":\"Failed SignInLogs Activity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"EmailEvents\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| where RecipientEmailAddress =~ '{Variable}'\\r\\n| project TimeGenerated, SenderFromAddress, Subject, AttachmentCount, UrlCount, DeliveryAction, EmailDirection, EmailLanguage\\r\\n| order by TimeGenerated desc\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Received Emails\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"filter\":true}},\"name\":\"Received Emails\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"EmailEvents\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| where SenderFromAddress=~ '{Variable}'\\r\\n| project TimeGenerated, RecipientEmailAddress, Subject, AttachmentCount, UrlCount, DeliveryAction, EmailDirection, EmailLanguage\\r\\n| order by TimeGenerated desc\",\"size\":1,\"showAnalytics\":true,\"title\":\"Sent Emails\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"filter\":true}},\"name\":\"Sent Emails\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"EmailAttachmentInfo\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| where SenderFromAddress =~ '{Variable}' or RecipientEmailAddress =~ '{Variable}'\\r\\n| project TimeGenerated, FileName, FileType, RecipientEmailAddress, SenderFromAddress, SHA256, FileSize\\r\\n| order by TimeGenerated desc\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Attachment Info in emails\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"filter\":true}},\"name\":\"Attachment Info in emails\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"EmailUrlInfo\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| join kind=inner (\\r\\n    EmailEvents\\r\\n    | project SenderFromAddress, RecipientEmailAddress, NetworkMessageId\\r\\n) on NetworkMessageId\\r\\n| where SenderFromAddress =~ '{Variable}' or RecipientEmailAddress =~ '{Variable}'\\r\\n| project TimeGenerated, Url, UrlLocation, Domain = UrlDomain, Sender = SenderFromAddress, Recipient = RecipientEmailAddress\\r\\n| order by TimeGenerated desc\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"URL Info in emails\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"filter\":true}},\"name\":\"URL Info in emails\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AuditLogs\\r\\n| where OperationName has \\\"Reset\\\"\\r\\n| extend ipAddress = tostring(parse_json(tostring(InitiatedBy.user)).ipAddress)\\r\\n| extend Account = tostring(TargetResources[0].displayName), \\r\\n          InitiatingUser = tostring(InitiatedBy.user.userPrincipalName)\\r\\n| where InitiatingUser =~ '{Variable}' or Account =~ '{Variable}'\\r\\n| project TimeGenerated, Account, InitiatingUser, ResultDescription, ActivityDateTime, Location, ipAddress\\r\\n| sort by TimeGenerated desc\\r\\n\",\"size\":4,\"showAnalytics\":true,\"title\":\"AzureAD Password Resets\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"AzureAD Password Resets\"}],\"exportParameters\":true},\"conditionalVisibility\":{\"parameterName\":\"EntityType\",\"comparison\":\"isEqualTo\",\"value\":\"user\"},\"name\":\"Email Triage\",\"styleSettings\":{\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Host Triage\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Heartbeat\\r\\n| where Computer == \\\"{Variable}\\\" or ComputerIP == \\\"{Variable}\\\" or ComputerPrivateIPs contains \\\"{Variable}\\\"\\r\\n| project TimeGenerated, Computer, ComputerIP, OSType, OSName, RemoteIPCountry, ComputerPrivateIPs, ComputerEnvironment\\r\\n| take 1\",\"size\":3,\"showAnalytics\":true,\"title\":\"Heartbeat Host Details\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"rowLimit\":1},\"tileSettings\":{\"showBorder\":false},\"graphSettings\":{\"type\":0}},\"name\":\"Heartbeat Host Details\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Syslog\\r\\n| where Computer =~ '{Variable}'\\r\\n| project-reorder TimeGenerated, Computer, Facility, ProcessName, SyslogMessage\",\"size\":1,\"showAnalytics\":true,\"title\":\"SysLog Table\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"rowLimit\":50}},\"name\":\"SysLog Table\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let searchvalue = \\\"{Variable}\\\";\\r\\nDeviceNetworkEvents\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| where DeviceName has '{Variable}'\\r\\n| where InitiatingProcessCommandLine !contains \\\"MsSense.exe\\\"\\r\\n| where InitiatingProcessCommandLine !contains \\\"svchost.exe -k utcsvc\\\"\\r\\n| extend Protocol = case(\\r\\n    ActionType contains \\\"HTTP\\\", \\\"HTTP\\\",\\r\\n    ActionType contains \\\"Https\\\", \\\"HTTPS\\\",\\r\\n    ActionType contains \\\"DNS\\\", \\\"DNS\\\",\\r\\n    ActionType contains \\\"ssh\\\", \\\"SSH\\\",\\r\\n    ActionType contains \\\"rdp\\\", \\\"RDP\\\",\\r\\n    ActionType contains \\\"ftp\\\", \\\"FTP\\\",\\r\\n    \\\"Other\\\"\\r\\n)\\r\\n| project NetworkTime = TimeGenerated, \\r\\n          DeviceName, \\r\\n          Protocol, \\r\\n          ActionType,\\r\\n          LocalPort, \\r\\n          RemotePort, \\r\\n          InitiatingProcessCommandLine\\r\\n| order by NetworkTime desc\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Recent Device Network Activity\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"rowLimit\":50}},\"name\":\"Recent Device Network Activity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let searchvalue = \\\"{Variable}\\\";\\r\\nDeviceNetworkEvents\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| where DeviceName has '{Variable}' and RemoteIPType == \\\"Public\\\"\\r\\n| summarize ConnectionCount = count() by RemoteIP, RemotePort, URL\\r\\n| order by ConnectionCount desc\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Connections to Public IPs\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"rowLimit\":50}},\"name\":\"Connections to Public IPs\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let HostnameParam = '{Variable}';\\r\\nDeviceInfo\\r\\n| where DeviceName has HostnameParam\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| take 10\\r\\n| extend UserName = tostring(LoggedOnUsers[0].UserName)\\r\\n| project TimeGenerated, DeviceName, UserName, IsAzureADJoined,  OS = OSPlatform, Version = OSVersion, PublicIP\\r\\n| order by TimeGenerated desc\",\"size\":1,\"showAnalytics\":true,\"title\":\"Recent DeviceInfo Events\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"Recent DeviceInfo Events\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let HostnameParam = '{Variable}';\\r\\nDeviceInfo\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| where DeviceName has HostnameParam\\r\\n| where LoggedOnUsers <> \\\"[]\\\"\\r\\n| extend UserName = tostring(LoggedOnUsers[0].UserName)\\r\\n| summarize EventCount = count() by UserName, DeviceName\\r\\n| order by EventCount desc\",\"size\":1,\"showAnalytics\":true,\"title\":\"Common Users via DeviceInfo\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"sortBy\":[]},\"name\":\"Common Users via DeviceInfo\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let HostnameParam = '{Variable}';\\r\\nSecurityEvent\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| where EventID in (4624, 4625) // 4624 for successful logon, 4625 for logon failure\\r\\n| where Computer has HostnameParam // Filter events for the specific hostname\\r\\n| summarize count() by Account, AccountType, LogonType, IpAddress, WorkstationName, Status\\r\\n| order by count_ desc\\r\\n| take 100 // Adjust as necessary to capture the desired number of events\",\"size\":3,\"showAnalytics\":true,\"title\":\"SysLog signins to host\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"sortBy\":[]},\"name\":\"SysLog signins to host\"}],\"exportParameters\":true},\"conditionalVisibility\":{\"parameterName\":\"EntityType\",\"comparison\":\"isEqualTo\",\"value\":\"host\"},\"name\":\"Host Triage\",\"styleSettings\":{\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Public IP Triage \",\"loadType\":\"explicit\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OfficeActivity\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| where ClientIP == '{Variable}'\\r\\n| join kind=leftouter (SigninLogs\\r\\n    | where IPAddress == '{Variable}'\\r\\n    | extend city_ = tostring(LocationDetails.city)\\r\\n    | extend state_ = tostring(LocationDetails.state)\\r\\n    | extend countryOrRegion_ = tostring(LocationDetails.countryOrRegion)\\r\\n    | extend fullLocation = strcat(\\r\\n                                iff(isempty(city_), '', strcat(city_, ', ')), \\r\\n                                iff(isempty(state_), '', strcat(state_, ', ')), \\r\\n                                countryOrRegion_\\r\\n                            )\\r\\n    | project SignIn_IPAddress = IPAddress, fullLocation)\\r\\n    on $left.ClientIP == $right.SignIn_IPAddress\\r\\n| summarize ActivityCount = count() by UserId, Operation, UserAgent, fullLocation, SignIn_IPAddress\\r\\n| order by ActivityCount asc\",\"size\":1,\"showAnalytics\":true,\"title\":\"Uncommon Office 365 Activity from IP\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"Uncommon Office 365 Activity from IP\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OfficeActivity\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| where ClientIP == '{Variable}'\\r\\n| join kind=leftouter (SigninLogs\\r\\n    | where IPAddress == '{Variable}'\\r\\n    | extend city_ = tostring(LocationDetails.city)\\r\\n    | extend state_ = tostring(LocationDetails.state)\\r\\n    | extend countryOrRegion_ = tostring(LocationDetails.countryOrRegion)\\r\\n    | extend fullLocation = strcat(\\r\\n                                iff(isempty(city_), '', strcat(city_, ', ')), \\r\\n                                iff(isempty(state_), '', strcat(state_, ', ')), \\r\\n                                countryOrRegion_\\r\\n                            )\\r\\n    | project SignIn_IPAddress = IPAddress, fullLocation)\\r\\n    on $left.ClientIP == $right.SignIn_IPAddress\\r\\n| order by TimeGenerated desc\",\"size\":1,\"showAnalytics\":true,\"title\":\"Recent Office 365 Activity from IP\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"Recent Office 365 Activity from IP\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| where IPAddress == '{Variable}'\\r\\n| extend city_ = tostring(LocationDetails.city), \\r\\n        state_ = tostring(LocationDetails.state), \\r\\n        countryOrRegion_ = tostring(LocationDetails.countryOrRegion),\\r\\n        OS = tostring(DeviceDetail.operatingSystem),\\r\\n        DeviceName = tostring(DeviceDetail.displayName)\\r\\n| extend DeviceName = tostring(DeviceDetail.displayName)\\r\\n| summarize Count = count() by ResultType, ResultDescription, city_, state_, countryOrRegion_,\\r\\n        UserPrincipalName, \\r\\n        ResourceDisplayName, \\r\\n        DeviceName,\\r\\n        OS,\\r\\n        ConditionalAccessStatus,\\r\\n        TokenIssuerType\\r\\n| order by Count desc\",\"size\":1,\"showAnalytics\":true,\"title\":\"Common Azure SignIn Activity\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"Common Azure SignIn Activity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SigninLogs\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| where IPAddress == '{Variable}'\\r\\n| extend city_ = tostring(LocationDetails.city), \\r\\n        state_ = tostring(LocationDetails.state), \\r\\n        countryOrRegion_ = tostring(LocationDetails.countryOrRegion),\\r\\n        OS = tostring(DeviceDetail.operatingSystem),\\r\\n        DeviceName = tostring(DeviceDetail.displayName)\\r\\n| extend DeviceName = tostring(DeviceDetail.displayName)\\r\\n| project TimeGenerated, ResultType, ResultDescription, city_, state_, countryOrRegion_,\\r\\n        UserPrincipalName, \\r\\n        ResourceDisplayName, \\r\\n        DeviceName,\\r\\n        OS,\\r\\n        ConditionalAccessStatus,\\r\\n        TokenIssuerType\\r\\n| order by TimeGenerated desc\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Recent Azure SignIn Activity\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"Recent Azure SignIn Activity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureActivity\\r\\n| search \\\"{Variable}\\\"\\r\\n| extend ActionPath = tostring(parse_json(Properties).message)\\r\\n| extend SourceResource = tostring(parse_json(Properties).resource)\\r\\n| extend AuthroizedRole = tostring(parse_json(tostring(parse_json(Authorization).evidence)).role)\\r\\n| project TimeGenerated, CallerIpAddress, ActivityStatusValue, ResourceGroup, ActionPath, SourceResource, AuthroizedRole\\r\\n| order by TimeGenerated desc\",\"size\":1,\"showAnalytics\":true,\"title\":\"AzureActivity from IP\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"Azure Activity from IP\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"AzureDataExplorerQuery/1.0\\\",\\\"queryText\\\":\\\"SigninLogs\\\\r\\\\n| where IPAddress == \\\\\\\"{Variable}\\\\\\\"\\\\r\\\\n| extend Geo = parse_json(tostring(parse_json(LocationDetails)['geoCoordinates']))\\\\r\\\\n| extend Latitude = toreal((tostring(parse_json(Geo)['latitude'])))\\\\r\\\\n| extend Longitude = toreal(parse_json(tostring(parse_json(Geo)['longitude'])))\\\\r\\\\n| summarize Count = count() by Longitude, Latitude, IPAddress\\\\r\\\\n| project Longitude, Latitude, Count, IPAddress\\\\r\\\\n| render scatterchart with (kind=map)\\\",\\\"clusterName\\\":\\\"ibwcsoc2131cluster.southcentralus\\\",\\\"databaseName\\\":\\\"M2131\\\"}\",\"size\":3,\"showAnalytics\":true,\"title\":\"IP Location - PublicIP\",\"showExportToExcel\":true,\"queryType\":9,\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"Latitude\",\"longitude\":\"Longitude\",\"sizeSettings\":\"Longitude\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"Longitude\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"Longitude\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"name\":\"IP Location - PublicIP (IBWC ONLY)\",\"styleSettings\":{\"showBorder\":true}}],\"exportParameters\":true},\"conditionalVisibility\":{\"parameterName\":\"EntityType\",\"comparison\":\"isEqualTo\",\"value\":\"publicip\"},\"name\":\"Public IP Triage \",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let ip_address = '{Variable}';\\r\\n// Collecting security events related to the IP address within the specified time range\\r\\nSecurityEvent\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| where IpAddress == ip_address\\r\\n| where EventID in (4624, // An account was successfully logged on\\r\\n                    4625, // An account failed to log on\\r\\n                    4648, // A logon was attempted using explicit credentials\\r\\n                    4672) // Special privileges assigned to new logon\\r\\n| summarize Count = count() by Account, Computer, EventID, Activity, LogonType\\r\\n| order by Count desc\",\"size\":0,\"showAnalytics\":true,\"title\":\"Common Syslog Logon Events - PrivateIP\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"conditionalVisibility\":{\"parameterName\":\"EntityType\",\"comparison\":\"isEqualTo\",\"value\":\"privateip\"},\"name\":\"Common Syslog Logon Events - PrivateIP\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Private IP Triage\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let ip_address = '{Variable}';\\r\\nSecurityEvent\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| where EventID == 4624 // An account was successfully logged on\\r\\n| where IpAddress == ip_address\\r\\n| summarize HostLogonCount = count() by Computer\\r\\n| order by HostLogonCount desc\",\"size\":1,\"showAnalytics\":true,\"title\":\"Most Common Hosts - Windows Events\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"customWidth\":\"45\",\"name\":\"Most Common Hosts - Windows Events\",\"styleSettings\":{\"maxWidth\":\"50\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let ip_address = '{Variable}';\\r\\nSecurityEvent\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| where EventID == 4624 // An account was successfully logged on\\r\\n| where IpAddress == ip_address\\r\\n| summarize UserHostLogonCount = count() by TargetUserName, Computer\\r\\n| top 5 by UserHostLogonCount desc\",\"size\":1,\"showAnalytics\":true,\"title\":\" Users Logged Into Specific Hosts - Windows Events\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"customWidth\":\"45\",\"name\":\" Users Logged Into Specific Hosts - Windows Events\",\"styleSettings\":{\"maxWidth\":\"50\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let DeviceNameFromIP = Heartbeat\\r\\n| where ComputerPrivateIPs has \\\"{Variable}\\\" \\r\\n| extend DeviceName = tostring(split(Computer, \\\".\\\")[0])\\r\\n| summarize by DeviceName; \\r\\nSigninLogs\\r\\n| where ResultType == \\\"0\\\"\\r\\n| extend DeviceName = tostring(DeviceDetail.displayName)\\r\\n| join kind=inner DeviceNameFromIP on DeviceName \\r\\n| extend city_ = tostring(LocationDetails.city)\\r\\n| extend state_ = tostring(LocationDetails.state)\\r\\n| extend countryOrRegion_ = tostring(LocationDetails.countryOrRegion)\\r\\n| extend fullLocation = strcat(\\r\\n    iff(isempty(city_), '', strcat(city_, ', ')), \\r\\n    iff(isempty(state_), '', strcat(state_, ', ')), \\r\\n    countryOrRegion_)\\r\\n| project TimeGenerated, DeviceName, UserPrincipalName, UserDisplayName, fullLocation, AppDisplayName, IPAddress, UserAgent\",\"size\":1,\"showAnalytics\":true,\"title\":\"SignInLogs Events from Associated Host\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"filter\":true}},\"name\":\"SignInLogs Events from Associated Host\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Heartbeat\\r\\n| where ComputerPrivateIPs contains \\\"{Variable}\\\"\\r\\n| project TimeGenerated, Computer, ComputerIP, OSType, OSName, RemoteIPCountry, ComputerPrivateIPs, ComputerEnvironment\\r\\n| take 1\",\"size\":3,\"showAnalytics\":true,\"title\":\"Heartbeat Device Info\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"Heartbeat Device Info\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let ip_address = '{Variable}';\\r\\nDeviceNetworkEvents\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| where LocalIP == ip_address or RemoteIP == ip_address\\r\\n//| where ActionType !contains \\\"inspected\\\"\\r\\n| extend Protocol = case(\\r\\n    ActionType contains \\\"HTTP\\\", \\\"HTTP\\\",\\r\\n    ActionType contains \\\"Https\\\", \\\"HTTPS\\\",\\r\\n    ActionType contains \\\"DNS\\\", \\\"DNS\\\",\\r\\n    ActionType contains \\\"ssh\\\", \\\"SSH\\\",\\r\\n    ActionType contains \\\"rdp\\\", \\\"RDP\\\",\\r\\n    ActionType contains \\\"ftp\\\", \\\"FTP\\\",\\r\\n    \\\"Other\\\"\\r\\n)\\r\\n| project-reorder TimeGenerated, \\r\\n          LocalIP, \\r\\n          RemoteIP, \\r\\n          Protocol, \\r\\n          ActionType,\\r\\n          LocalPort, \\r\\n          RemotePort, \\r\\n          InitiatingProcessCommandLine\\r\\n| order by TimeGenerated desc\",\"size\":1,\"showAnalytics\":true,\"title\":\"Host Network Connections\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"Host Network Connections\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let ip_address = '{Variable}';\\r\\nSyslog\\r\\n| extend \\r\\n//    SerialNumber = extract(\\\"sn=([\\\\\\\\w\\\\\\\\d]+)\\\", 1, SyslogMessage),\\r\\n//    Firewall = extract(\\\"fw=([\\\\\\\\d\\\\\\\\.]+)\\\", 1, SyslogMessage),\\r\\n//    Priority = extract(\\\"pri=(\\\\\\\\d+)\\\", 1, SyslogMessage),\\r\\n    Message = extract(\\\"msg=\\\\\\\"([^\\\\\\\"]+)\\\\\\\"\\\", 1, SyslogMessage),\\r\\n//    SrcMac = extract(\\\"srcMac=([\\\\\\\\w\\\\\\\\d:]+)\\\", 1, SyslogMessage),\\r\\n    SrcIP = extract(\\\"src=([\\\\\\\\d\\\\\\\\.]+):\\\", 1, SyslogMessage),\\r\\n    SrcPort = extract(\\\"src=[\\\\\\\\d\\\\\\\\.]+:(\\\\\\\\d+)\\\", 1, SyslogMessage),\\r\\n//    NatSrc = extract(\\\"natSrc=([\\\\\\\\d\\\\\\\\.]+)\\\", 1, SyslogMessage),\\r\\n//    DstMac = extract(\\\"dstMac=([\\\\\\\\w\\\\\\\\d:]+)\\\", 1, SyslogMessage),\\r\\n    DstIP = extract(\\\"dst=([\\\\\\\\d\\\\\\\\.]+):\\\", 1, SyslogMessage),\\r\\n    DstPort = extract(\\\"dst=[\\\\\\\\d\\\\\\\\.]+:(\\\\\\\\d+)\\\", 1, SyslogMessage),\\r\\n    Protocol = extract(\\\"proto=([\\\\\\\\w\\\\\\\\d]+)\\\\\\\\/\\\", 1, SyslogMessage),\\r\\n    Application = extract(\\\"proto=[\\\\\\\\w\\\\\\\\d]+\\\\\\\\/([a-zA-Z]+)\\\", 1, SyslogMessage),\\r\\n    Category = extract(\\\"Category=\\\\\\\"([^\\\\\\\"]+)\\\\\\\"\\\", 1, SyslogMessage),\\r\\n    FirewallAction = extract(\\\"fw_action=\\\\\\\"([^\\\\\\\"]+)\\\\\\\"\\\", 1, SyslogMessage)\\r\\n //   Code = extract(\\\"code=(\\\\\\\\d+)\\\", 1, SyslogMessage)\\r\\n| where SrcIP == ip_address or DstIP == ip_address \\r\\n| project TimeGenerated, Message, SrcIP, SrcPort, DstIP, DstPort, Protocol, Application, Category, FirewallAction\\r\\n| order by TimeGenerated desc\",\"size\":1,\"showAnalytics\":true,\"title\":\"Syslog FW Connection Events\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"filter\":true}},\"name\":\"Syslog FW Connection Events\"}],\"exportParameters\":true},\"conditionalVisibility\":{\"parameterName\":\"EntityType\",\"comparison\":\"isEqualTo\",\"value\":\"ip\"},\"name\":\"Private IP Triage\",\"styleSettings\":{\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"AD User Triage\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityEvent\\r\\n| where TimeGenerated >= {Timerange:start} and TimeGenerated <= {Timerange:end}\\r\\n| search @'{Variable}'\\r\\n| project-away $table, TenantId, SourceSystem, EventSourceName, Channel, Task, Level, EventData\\r\\n| order by TimeGenerated desc\",\"size\":1,\"showAnalytics\":true,\"title\":\"SecurityEvent Table\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"filter\":true}},\"name\":\"SecurityEvent Table\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityEvent\\r\\n| where Account contains @'{Variable}'\\r\\n| where EventID in (4727, 4728, 4729, 4730, 4731, 4732, 4733, 4734, 4735, 4737, 4754, 4755, 4756, 4757, 4758, 4759)\\r\\n| project TimeGenerated, Computer, TargetUserName, SubjectUserName, MemberSid\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Security Group Management\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"Security Group Management\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityEvent\\r\\n| where Account contains @'{Variable}'\\r\\n| where EventID in (4720, 4722, 4725, 4726, 4738)\\r\\n| project TimeGenerated, Computer, TargetUserName, SubjectUserName, Activity\\r\\n| order by TimeGenerated desc\",\"size\":1,\"showAnalytics\":true,\"title\":\"User Account Changes (Creation, Deletion, Modification)\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"filter\":true}},\"name\":\"User Account Changes (Creation, Deletion, Modification)\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityEvent\\r\\n| where Account contains @'{Variable}'\\r\\n| where EventID == 4688 and NewProcessName contains \\\"powershell\\\"\\r\\n| project-reorder TimeGenerated, Computer, CommandLine\",\"size\":1,\"showAnalytics\":true,\"title\":\"Powershell usage\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"Powershell usage\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityEvent\\r\\n| where Account contains @'{Variable}'\\r\\n| where EventID in (\\\"4779\\\", \\\"1149\\\") or (EventID == 4624 and LogonType == 10) or (EventID == 4625 and LogonType == 10)\\r\\n| project TimeGenerated, Activity, AccountName, ClientAddress, IpAddress, Computer\\r\\n| order by TimeGenerated desc\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"RDP Sessions via EventID\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"filter\":true}},\"name\":\"RDP Sessions via EventID\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let suspiciousAccount = @'{Variable}';\\r\\nlet AllEvents = SecurityEvent\\r\\n| where Account contains suspiciousAccount and EventID in (4624, 4634, 4672)\\r\\n| where LogonType in (\\\"2\\\", \\\"10\\\", \\\"11\\\", \\\"12\\\")\\r\\n| extend LogonId = TargetLogonId\\r\\n| extend EventType = case(EventID == 4624, \\\"Logon\\\", EventID == 4634, \\\"Logoff\\\", EventID == 4672, \\\"SpecialLogon\\\", \\\"Other\\\")\\r\\n| project TimeGenerated, Account, LogonId, EventType, Computer, LogonType;\\r\\nAllEvents\\r\\n| summarize MinTime=min(TimeGenerated), MaxTime=max(TimeGenerated), SpecialLogonOccurred=any(EventType == \\\"SpecialLogon\\\") by LogonId, Account, Computer, LogonType\\r\\n| extend SessionLengthSeconds = datetime_diff('second', MaxTime, MinTime)\\r\\n| extend Days = toint(SessionLengthSeconds / 86400)\\r\\n| extend Hours = toint((SessionLengthSeconds % 86400) / 3600)\\r\\n| extend Minutes = toint((SessionLengthSeconds % 3600) / 60)\\r\\n| extend Seconds = SessionLengthSeconds % 60\\r\\n| extend SessionLengthFormatted = strcat(\\r\\n    tostring(Days), \\\"d:\\\",\\r\\n    iff(Hours < 10, strcat(\\\"0\\\", tostring(Hours)), tostring(Hours)), \\\"h:\\\",\\r\\n    iff(Minutes < 10, strcat(\\\"0\\\", tostring(Minutes)), tostring(Minutes)), \\\"m:\\\",\\r\\n    iff(Seconds < 10, strcat(\\\"0\\\", tostring(Seconds)), tostring(Seconds)), \\\"s\\\"\\r\\n)\\r\\n| where SessionLengthSeconds > 1 // Filter out any short sessions\\r\\n| project Account, SessionStart = MinTime, SessionEnd = MaxTime, SessionLengthFormatted, SpecialLogonOccurred, Computer, LogonType, LogonId\",\"size\":1,\"showAnalytics\":true,\"title\":\"Windows Event User Sessions\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"Windows Event User Sessions\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityEvent\\r\\n| where Account contains @'{Variable}'\\r\\n| where EventID in (\\\"4624\\\")\\r\\n| project TimeGenerated, Account, IpAddress, LogonTypeName, Computer, Activity\\r\\n| join kind=inner (\\r\\n    Heartbeat\\r\\n    | extend IpAddress = tostring(ComputerPrivateIPs[0])\\r\\n    | project OSName, ComputerEnvironment, IpAddress\\r\\n) on IpAddress\\r\\n| project-away IpAddress1\\r\\n| summarize Count = count() by Computer, IpAddress, Account\\r\\n| order by Count desc \\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Unique Hosts Successfully Logged Into\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"Unique Hosts Successfully Logged Into\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityEvent\\r\\n| where Account contains @'{Variable}'\\r\\n| where EventID in (\\\"4625\\\", \\\"4771\\\", \\\"4776\\\")\\r\\n| project-reorder TimeGenerated, Account, IpAddress, LogonTypeName, Computer, Activity\\r\\n| join kind=leftouter (\\r\\n    Heartbeat\\r\\n    | extend IpAddress = tostring(ComputerPrivateIPs[0])\\r\\n    | project OSName, ComputerEnvironment, IpAddress\\r\\n) on IpAddress\\r\\n| project-away IpAddress1\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Failed Logon Activity\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"Failed Logon Activity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityEvent\\r\\n| where Account contains @'{Variable}'\\r\\n| where EventID == \\\"4624\\\"\\r\\n| project TimeGenerated, IpAddress, LogonType, Computer\\r\\n| join kind=leftouter (\\r\\n    Heartbeat\\r\\n    | extend IpAddress = tostring(ComputerPrivateIPs[0])\\r\\n    | project OSName, ComputerEnvironment, IpAddress\\r\\n) on IpAddress\\r\\n| project-away IpAddress1\",\"size\":1,\"showAnalytics\":true,\"title\":\"Successful Logon Activity\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"]},\"name\":\"Successful Logon Activity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityEvent\\r\\n| where TargetAccount contains @'{Variable}'\\r\\n| where EventID in (\\\"4723\\\", \\\"4724\\\")\\r\\n| project TimeGenerated, SourceAccount = Account, Computer, TargetAccount, Activity\",\"size\":4,\"showAnalytics\":true,\"title\":\"Windows Password Resets\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"filter\":true}},\"name\":\"Windows Password Resets\"}],\"exportParameters\":true},\"conditionalVisibility\":{\"parameterName\":\"EntityType\",\"comparison\":\"isEqualTo\",\"value\":\"aduser\"},\"name\":\"AD User Triage\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let StartDate = ago(30d);\\r\\nlet EndDate = now();\\r\\nlet TimeInterval = 1h; // Adjust the time interval as necessary\\r\\nunion *\\r\\n| where TimeGenerated between (StartDate .. EndDate)\\r\\n| search @'{Variable}'\\r\\n| summarize Count = count() by bin(TimeGenerated, TimeInterval)\\r\\n| union (\\r\\n    range TimeGenerated from StartDate to EndDate step TimeInterval\\r\\n    | extend Count = 0 // This creates the zero-value rows for dates without any logs\\r\\n)\\r\\n| summarize EventCount = sum(Count) by bin(TimeGenerated, TimeInterval)\\r\\n| render timechart\",\"size\":0,\"showAnalytics\":true,\"title\":\"30 Day Log source count\",\"timeContextFromParameter\":\"Timerange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"timechart\"},\"name\":\"30 Day Log source count\",\"styleSettings\":{\"showBorder\":true}}],\"isLocked\":false,\"fallbackResourceIds\":[\"/subscriptions/193adb00-3bae-469e-b548-830a894810a0/resourcegroups/quzara-monitoring/providers/microsoft.operationalinsights/workspaces/quzara-corporate\"],\"fromTemplateId\":\"sentinel-UserWorkbook\"}",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}